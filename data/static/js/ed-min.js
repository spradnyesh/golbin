$(document).ready(function(){var p="all";var q={all:0,me:0};var c="next";var G=false;var L=false;var v=function(M){return M.split(/,\s*/)};var h=function(M){return v(M).pop()};var f=function(M,O,N){if(stringEqual(O,"parseerror")){alert("Received an invalid response from server. Please try again after some time.")}else{alert("Network error")}return false};var b=function(M){return decodeURIComponent((new RegExp("[?|&]"+M+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null};var o=function(M){M.bind("keydown",function(N){return N.keyCode===$.ui.keyCode.TAB&&$(this).data("autocomplete").menu.active?N.preventDefault():null}).autocomplete({"min-length":2,source:function(O,N){$.ajax({url:"/ajax/tags/?d1m="+b("d1m"),data:{term:h(O.term)},"data-type":"json",success:N});return false},search:function(){var N=h(this.value);return N.length<2?false:true},focus:function(){return false},select:function(O,P){var N=v(this.value);N.pop();N.push(P.item.value);N.push("");this.value=N.join(", ");return false}});return false};var t=function(N){var Q=parseInt($(N+" .cat").val());var S=null;if(Q===0){$(N+" .subcat").empty();return $(N+" .subcat").append($("<option selected='selected' value='0'>Select</option>"))}else{for(var O=null,R=0;R<categoryTree.length;R+=1){O=categoryTree[R];if(Q===O[0].id){$(N+" .subcat").empty();if(O[1]){for(var T=null,M=O[1],P=0;P<M.length;P+=1){T=M[P];S=$("<option></option>").val(""+T.id).text(T.name);$(N+" .subcat").append(S)}}}}}};var e=function(){return $("#article form").attr("action","/ajax"+$("#article form").attr("action"))};var C=function(){event.preventDefault();CKEDITOR.instances.body.updateElement();$("#article form").ajaxSubmit({"data-type":"json",cache:false,async:false,success:function(N,O,M){return F(N,O,M)},error:function(M,O,N){return f(M,O,N)}});return false};var F=function(N,O,M){if(N.status==="success"){window.location=N.data}else{d(N)}return false};var d=function(M){if(null!==M.errors.nonGolbinImages){$("#body").parent().append($("<p class='error'>Body contains images not hosted on Golbin. Please upload your images to Golbin first, and then use them inside the body</p>"))}alert("There are errors in the submitted article. Please correct them and submit again.");return false};var a=function(){$("#bd").append($("<div id='photo-pane'><p><a class='close' href=''>Close</a></p><ul></ul></div>"));return $("#photo-pane a.close").click(function(){return x()})};var D=function(M){G=false;return false};var x=function(){event.preventDefault();$("#photo-pane").remove();return false};var I=function(){event.preventDefault();return alert("Please copy this URL and use it for inline images in the article body below: "+$($(event.target)).attr("src").replace("_"+imageSizes[0]+".","_"+imageSizes[1]+"."))};var r=function(){event.preventDefault();$("#lead-photo").val("");$("#lead-photo").siblings("span").children("img").remove();return $("#unselect-lead-photo").remove()};var u=function(){L=true;return j()};var i=function(){L=false;return j()};var j=function(){a();$("#photo-pane").append($("<div class='pagination'><a href='' class='prev'>Previous</a><a href='' class='next'>Next</a></div>"));$("#photo-pane p").prepend($("<div class='search'></div>"));s();K();m("all",0);$("#photo-pane .pagination a.prev").click(function(){return l()});return $("#photo-pane .pagination a.next").click(function(){return H()})};var s=function(){$("#photo-pane p").prepend($("<span>Photos<a class='all-photos' href=''> All </a><a class='my-photos' href=''> My </a></span>"));$("#photo-pane a.all-photos").click(function(){return m("all",0)});return $("#photo-pane a.my-photos").click(function(){return m("me",0)})};var K=function(){var N=$("<select name='cat' class='td-input cat'><option selected='selected' value='0'>Select</option></select>");var T=$("<select name='subcat' class='td-input subcat'><option selected='selected' value='0'>Select</option></select>");var O=$("<input class='td-input tags' type='text'>");var R=$("<a href='' class='search-btn'>Search</a>");$("#photo-pane .search").append(N).append(T).append(O).append(R);var M=null;var S=null;for(var Q=null,P=0;P<categoryTree.length;P+=1){Q=categoryTree[P];M=Q[0];S=$("<option></option>").val(""+M.id).text(M.name);$("#photo-pane .search .cat").append(S)}$("#photo-pane .search .cat").change(function(){return t("#photo-pane .search")});o($("#photo-pane .search .tags"));return $("#photo-pane .search a.search-btn").click(function(){return m(p,q[p])})};var m=function(M,N){if(N<0){return}event.preventDefault();p=M;$.ajax({url:"/ajax/photos/"+M+"/"+N+"/?cat="+$("#photo-pane .search .cat").val()+"&subcat="+$("#photo-pane .search .subcat").val()+"&tags="+$("#photo-pane .search .tags").val()+"&d1m="+b("d1m"),cache:false,"data-type":"json",async:false}).done(function(O){return w(O)}).fail(function(O){return D(O)});return false};var w=function(P){if(P.status==="success"){if(G){if(c==="prev"){q[p]-=1}else{q[p]+=1}G=false}$("#photo-pane ul").empty();for(var R=null,O=0;O<P.data.length;O+=1){R=P.data[O];var S=$("<span></span>").html(R[0]);var N=$(R[1]);var Q=$("<p></p>").append($(N).attr("alt"));var M=$("<a href=''></a>").append(N);$(M).click(function(){return g()});$("#photo-pane ul").append($("<li></li>").append(S).append(M).append(Q))}}else{return D(P)}};var g=function(){event.preventDefault();var O=$(event.target);if(L){$("#lead-photo").val(O.parent().siblings("span").html());var M=$("#lead-photo").siblings("span");M.html(O);M.append($("<a id='unselect-lead-photo' href=''>Unselect photo. </a>"));$("#unselect-lead-photo").click(function(){return r()})}else{var N=$("<a href=''></a>").append(O);$("#nonlead-photo").siblings("span").append(N);$(N).click(function(){return I()})}return x()};var l=function(){event.preventDefault();c="prev";G=true;return m(p,q[p]-2)};var H=function(){event.preventDefault();c="next";G=true;return m(p,q[p])};var k=function(){L=true;return A()};var B=function(){L=false;return A()};var A=function(){event.preventDefault();a();$("#photo-pane ul").remove();E();return false};var E=function(){return $.ajax({url:"/ajax/photo/?d1m="+b("d1m"),"data-type":"json",async:false}).done(function(M){return n(M)}).fail(function(M){return D(M)})};var n=function(M){if(M.status==="success"){$("#photo-pane").append(M.data);$("#photo-pane form").submit(function(){return J()});$("#photo-pane .cat").change(function(){return t("#photo-pane")});o($("#photo-pane .tags"));return false}else{return D(M)}};var J=function(){event.preventDefault();$("#photo-pane form").ajaxSubmit({"data-type":"json",async:false,success:function(N,O,M){return y(N,O,M)},error:function(M,O,N){return f(M,O,N)}});return false};var y=function(O,P,N){if(O.status==="success"){if(L){$("#lead-photo").val(O.data[0]);$("#lead-photo").siblings("span").html(O.data[1])}else{var M=$("<a href=''></a>").append($(O.data[1]));$("#nonlead-photo").siblings("span").append(M);$(M).click(function(){return I()})}}else{D(O)}return x()};var z=function(M){return M.nestedSortable({handle:"div",items:"li",toleranceelement:"> div",maxlevels:1,protectroot:true})};$(".cat").change(function(){return t("")});$("#article form").submit(function(){return C()});$("#select-lead-photo").click(function(){return u()});$("#unselect-lead-photo").click(function(){return r()});$("#upload-lead-photo").click(function(){return k()});$("#select-nonlead-photo").click(function(){return i()});$("#upload-nonlead-photo").click(function(){return B()});e();o($(".tags"));z($("#sort-catsubcat"));return false});
